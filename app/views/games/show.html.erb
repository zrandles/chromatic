<div class="max-w-7xl mx-auto p-4 md:p-8">
  <!-- STICKY SCORE TICKER - Always Visible -->
  <% if @game.status == 'active' %>
    <div class="sticky top-0 z-50 bg-white border-b-4 shadow-lg mb-6 -mx-4 md:-mx-8 px-4 md:px-8 py-3">
      <div class="flex flex-wrap items-center justify-between max-w-7xl mx-auto gap-4">
        <!-- Score Comparison -->
        <div class="flex items-center gap-2 md:gap-4">
          <div class="px-3 md:px-4 py-2 rounded-lg <%= @game.player_score > @game.ai_score ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-800' %> font-bold text-sm md:text-base">
            YOU: <%= @game.player_score %>
          </div>
          <div class="text-xl md:text-2xl font-bold text-gray-400">vs</div>
          <div class="px-3 md:px-4 py-2 rounded-lg <%= @game.ai_score > @game.player_score ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-800' %> font-bold text-sm md:text-base">
            AI: <%= @game.ai_score %>
          </div>
        </div>

        <!-- Round & Deck Info -->
        <div class="flex items-center gap-2 md:gap-4 text-xs md:text-sm">
          <div class="font-semibold text-gray-700">
            Round <%= @game.current_round %>/<%= @game.total_rounds %>
          </div>
          <% deck_size = @game.game_state['deck'].length %>
          <div class="px-2 md:px-3 py-1 rounded-lg <%= deck_size <= 10 ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800' %> font-semibold">
            <%= deck_size %> cards
          </div>
        </div>

        <!-- Turn Indicator -->
        <% if @game.game_state['turn'] == 'player' %>
          <div class="px-3 md:px-4 py-2 bg-green-500 text-white rounded-lg font-bold animate-pulse text-sm md:text-base">
            YOUR TURN
          </div>
        <% else %>
          <div class="px-3 md:px-4 py-2 bg-gray-400 text-white rounded-lg font-bold text-sm md:text-base">
            AI THINKING...
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Back Link -->
  <%= link_to "‚Üê Back", root_path, class: "text-blue-600 hover:underline text-sm mb-4 inline-block" %>

  <!-- Flash Messages -->
  <% if notice %>
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
      <%= notice %>
    </div>
  <% end %>

  <% if alert %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <%= alert %>
    </div>
  <% end %>

  <!-- Round End Summary -->
  <% if @game.status == 'round_ending' %>
    <% summary = @game.game_state['round_summary'] %>
    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 md:p-8 text-center mb-8 border-2 border-blue-300">
      <h2 class="text-3xl md:text-4xl font-bold mb-4 text-blue-900">Round <%= summary['round'] %> Complete! üéâ</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 max-w-3xl mx-auto mb-6">
        <div class="bg-white rounded-lg p-6 border-2 border-green-300">
          <div class="text-2xl font-bold text-green-700 mb-2">Your Score</div>
          <div class="text-5xl font-bold text-green-600 mb-2"><%= summary['player_round_score'] %></div>
          <div class="text-sm text-gray-600 mb-2">
            <%= summary['player_path_count'] %> <%= 'path'.pluralize(summary['player_path_count']) %> √ó <%= summary['player_multiplier'] %>x
          </div>
          <% if summary['player_bonus'] && summary['player_bonus'] > 0 %>
            <div class="text-xs text-purple-700 font-bold mb-1">
              ‚≠ê Long Path Bonus: +<%= summary['player_bonus'] %> pts
            </div>
          <% end %>
          <div class="mt-4 text-lg">
            Total: <span class="font-bold text-green-700"><%= summary['player_total_before'] %> ‚Üí <%= @game.player_score %></span>
          </div>
        </div>

        <div class="bg-white rounded-lg p-6 border-2 border-red-300">
          <div class="text-2xl font-bold text-red-700 mb-2">AI Score</div>
          <div class="text-5xl font-bold text-red-600 mb-2"><%= summary['ai_round_score'] %></div>
          <div class="text-sm text-gray-600 mb-2">
            <%= summary['ai_path_count'] %> <%= 'path'.pluralize(summary['ai_path_count']) %> √ó <%= summary['ai_multiplier'] %>x
          </div>
          <% if summary['ai_bonus'] && summary['ai_bonus'] > 0 %>
            <div class="text-xs text-purple-700 font-bold mb-1">
              ‚≠ê Long Path Bonus: +<%= summary['ai_bonus'] %> pts
            </div>
          <% end %>
          <div class="mt-4 text-lg">
            Total: <span class="font-bold text-red-700"><%= summary['ai_total_before'] %> ‚Üí <%= @game.ai_score %></span>
          </div>
        </div>
      </div>

      <% if summary['player_round_score'] > summary['ai_round_score'] %>
        <p class="text-2xl text-green-600 font-bold mb-4">You won this round!</p>
      <% elsif summary['ai_round_score'] > summary['player_round_score'] %>
        <p class="text-2xl text-red-600 font-bold mb-4">AI won this round!</p>
      <% else %>
        <p class="text-2xl text-gray-600 font-bold mb-4">This round was a tie!</p>
      <% end %>

      <%= button_to "Continue to Round #{@game.current_round + 1} - Keep Building Your Paths!",
                    continue_round_game_path(@game),
                    method: :post,
                    data: { turbo: false },
                    class: "mt-4 px-10 py-4 bg-blue-600 text-white text-xl md:text-2xl rounded-lg hover:bg-blue-700 font-bold shadow-lg" %>
    </div>
  <% end %>

  <!-- Game Over -->
  <% if @game.status == 'finished' %>
    <div class="bg-gray-100 rounded-lg p-8 text-center mb-8">
      <h2 class="text-4xl font-bold mb-4">Game Over!</h2>
      <% if @game.winner == 'player' %>
        <p class="text-2xl text-green-600">You Win!</p>
      <% elsif @game.winner == 'ai' %>
        <p class="text-2xl text-red-600">AI Wins!</p>
      <% else %>
        <p class="text-2xl text-gray-600">It's a Tie!</p>
      <% end %>
      <div class="mt-4 text-xl">
        Final Score - You: <%= @game.player_score %> | AI: <%= @game.ai_score %>
      </div>
      <%= link_to "Play Again", root_path, class: "mt-6 inline-block px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700" %>
    </div>
  <% end %>

  <!-- HEAD-TO-HEAD PATH COMPARISON (Main Focus) -->
  <% if @game.status == 'active' %>
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl md:text-2xl font-bold text-gray-800">Path Battle</h2>

        <!-- Collapsible Rules Toggle -->
        <button
          id="rules-toggle-btn"
          onclick="document.getElementById('rules-panel').classList.toggle('hidden')"
          class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 font-semibold text-sm">
          üìö Toggle Rules
        </button>
      </div>

      <!-- Collapsible Rules Panel -->
      <div id="rules-panel" class="hidden bg-gray-50 border-2 border-gray-300 rounded-lg p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Color Rules -->
          <div>
            <h3 class="font-bold text-sm mb-2 text-gray-700">Color Rules</h3>
            <div class="space-y-1 text-xs">
              <div class="flex items-center gap-2">
                <span>üî¥</span>
                <span class="font-semibold">Red:</span>
                <span class="text-gray-600">Jump +2 (max 8)</span>
              </div>
              <div class="flex items-center gap-2">
                <span>üîµ</span>
                <span class="font-semibold">Blue:</span>
                <span class="text-gray-600">Pairs ¬±3 (max 10)</span>
              </div>
              <div class="flex items-center gap-2">
                <span>üü¢</span>
                <span class="font-semibold">Green:</span>
                <span class="text-gray-600">Consecutive (max 6)</span>
              </div>
              <div class="flex items-center gap-2">
                <span>üü°</span>
                <span class="font-semibold">Yellow:</span>
                <span class="text-gray-600">+1 to 3 (max 8)</span>
              </div>
              <div class="flex items-center gap-2">
                <span>üü£</span>
                <span class="font-semibold">Purple:</span>
                <span class="text-gray-600">Descend (no max)</span>
              </div>
            </div>
          </div>

          <!-- Scoring -->
          <div>
            <h3 class="font-bold text-sm mb-2 text-gray-700">Scoring</h3>
            <div class="space-y-1 text-xs">
              <div><span class="font-semibold">Base:</span> (cards)¬≤ ‚Üí 3 cards = 9 pts</div>
              <div><span class="font-semibold">Combo:</span> 2 paths = 1.1x, 5 paths = 1.6x</div>
              <div><span class="font-semibold">Bonus:</span> 5+ cards = +5, 7+ = +10, 10+ = +20</div>
            </div>
          </div>

          <!-- Costs -->
          <div>
            <h3 class="font-bold text-sm mb-2 text-gray-700">Path Costs</h3>
            <div class="space-y-1 text-xs">
              <div>1st path: <span class="font-bold text-green-600">FREE</span></div>
              <div>2nd path: 1 card</div>
              <div>3rd-5th paths: 2-4 cards</div>
              <div class="mt-2 text-blue-700 font-semibold">üîÑ Paths persist between rounds!</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Head-to-Head Comparison for Each Color -->
      <div class="space-y-3">
        <% ['red', 'blue', 'green', 'yellow', 'purple'].each do |color| %>
          <%
            player_path = @game.player_paths.find_by(color: color)
            ai_path = @game.ai_paths.find_by(color: color)

            color_emoji = case color
              when 'red' then 'üî¥'
              when 'blue' then 'üîµ'
              when 'green' then 'üü¢'
              when 'yellow' then 'üü°'
              when 'purple' then 'üü£'
            end

            color_rule = case color
              when 'red' then 'Jump +2'
              when 'blue' then 'Pairs ¬±3'
              when 'green' then 'Consecutive'
              when 'yellow' then '+1 to 3'
              when 'purple' then 'Descend'
            end

            bg_class = case color
              when 'red' then 'bg-red-50 border-red-300'
              when 'blue' then 'bg-blue-50 border-blue-300'
              when 'green' then 'bg-green-50 border-green-300'
              when 'yellow' then 'bg-yellow-50 border-yellow-300'
              when 'purple' then 'bg-purple-50 border-purple-300'
            end

            # Helper to format path display
            def format_path(path)
              return "None" if path.nil?
              cards = path.cards.map { |c| c['number'] }.join('‚Üí')
              "#{cards} (#{path.cards.length} cards, #{path.score} pts)"
            end

            player_display = format_path(player_path)
            ai_display = format_path(ai_path)

            # Determine winner for this color
            player_score = player_path&.score || 0
            ai_score = ai_path&.score || 0
          %>

          <div class="border-2 rounded-lg p-3 md:p-4 <%= bg_class %>">
            <!-- Color Header with Rule -->
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <span class="text-xl"><%= color_emoji %></span>
                <span class="font-bold capitalize text-gray-800"><%= color %></span>
                <span class="text-xs text-gray-600">(<%= color_rule %>)</span>
              </div>
              <!-- Winner Badge -->
              <% if player_score > 0 || ai_score > 0 %>
                <div class="text-xs font-bold <%= player_score > ai_score ? 'text-green-600' : (ai_score > player_score ? 'text-red-600' : 'text-gray-600') %>">
                  <%= if player_score > ai_score
                        "YOU LEAD"
                      elsif ai_score > player_score
                        "AI LEADS"
                      else
                        "TIED"
                      end %>
                </div>
              <% end %>
            </div>

            <!-- Side-by-Side Comparison -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <!-- Your Path -->
              <div class="bg-white rounded-lg p-3 border-2 <%= player_path ? 'border-green-300' : 'border-gray-200' %>">
                <div class="text-xs font-semibold text-gray-600 mb-1">YOU</div>
                <% if player_path %>
                  <div class="font-mono text-sm font-bold text-gray-800 mb-2">
                    <%= player_path.cards.map { |c| c['number'] }.join('‚Üí') %>
                  </div>
                  <div class="text-xs text-gray-600">
                    <%= player_path.cards.length %> cards ‚Ä¢ <span class="font-bold text-green-700"><%= player_path.score %> pts</span>
                  </div>
                  <!-- Next Play Hint -->
                  <div class="mt-2 pt-2 border-t border-gray-200 text-xs text-gray-700">
                    Next: <span class="font-semibold"><%= player_path.next_play_hint.gsub('Next: ', '').split('(')[0].strip %></span>
                  </div>
                <% else %>
                  <div class="text-gray-400 text-sm italic mb-2">Not started</div>
                  <!-- Starter Hint -->
                  <div class="mt-2 pt-2 border-t border-gray-200 text-xs text-gray-700">
                    <div class="mb-1">
                      Cost: <span class="font-semibold text-orange-700"><%= @game.starting_cost_for_path_number(@game.player_paths.count) == 0 ? 'FREE' : "#{@game.starting_cost_for_path_number(@game.player_paths.count)} card#{'s' if @game.starting_cost_for_path_number(@game.player_paths.count) > 1}" %></span>
                    </div>
                    <div class="text-gray-600">Must start with <%= color %> card</div>
                  </div>
                <% end %>
              </div>

              <!-- AI Path -->
              <div class="bg-white rounded-lg p-3 border-2 <%= ai_path ? 'border-red-300' : 'border-gray-200' %>">
                <div class="text-xs font-semibold text-gray-600 mb-1">AI</div>
                <% if ai_path %>
                  <div class="font-mono text-sm font-bold text-gray-800 mb-2">
                    <%= ai_path.cards.map { |c| c['number'] }.join('‚Üí') %>
                  </div>
                  <div class="text-xs text-gray-600">
                    <%= ai_path.cards.length %> cards ‚Ä¢ <span class="font-bold text-red-700"><%= ai_path.score %> pts</span>
                  </div>
                <% else %>
                  <div class="text-gray-400 text-sm italic">No path yet</div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Message if no paths yet -->
        <% if @game.player_paths.empty? && @game.ai_paths.empty? %>
          <div class="text-center py-12 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg">
            <div class="text-4xl mb-2">üéØ</div>
            <div class="text-lg font-bold text-gray-700 mb-1">No paths yet</div>
            <div class="text-sm text-gray-600">Play a card from your hand to start!</div>
            <div class="text-xs text-green-600 font-semibold mt-2">First path is FREE</div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- YOUR HAND - Clean Action Area -->
    <div class="bg-gradient-to-b from-blue-50 to-white border-2 border-blue-300 rounded-lg p-4 md:p-6 shadow-md">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg md:text-xl font-bold text-gray-800">üÉè Your Hand (<%= @game.player_hand.length %>)</h2>
        <div class="text-xs md:text-sm text-gray-600">
          Card color must match path color
        </div>
      </div>

      <div class="flex flex-wrap gap-3 md:gap-4 mb-4">
        <% @game.player_hand.each_with_index do |card, index| %>
          <%= render partial: 'card', locals: { card: card, index: index, game: @game } %>
        <% end %>
      </div>

      <!-- Spacer for sticky button -->
      <div class="h-24"></div>
    </div>

    <!-- STICKY END TURN BUTTON - Always visible at bottom -->
    <div class="fixed bottom-0 left-0 right-0 z-40 bg-gradient-to-t from-white via-white to-transparent pt-6 pb-4 px-4 md:px-8 shadow-2xl border-t-4 border-green-500">
      <div class="max-w-7xl mx-auto">
        <% hand_size = @game.player_hand.length %>

        <% if hand_size > 0 %>
          <div class="bg-blue-50 border border-blue-300 rounded-lg p-2 text-center mb-2 text-xs md:text-sm">
            <%= hand_size %> <%= 'card'.pluralize(hand_size) %> remaining ¬∑ Unplayed cards will be discarded
          </div>
        <% end %>

        <%= button_to "End Turn ‚Üí (AI plays next)",
                      end_turn_game_path(@game),
                      method: :post,
                      data: { turbo: false },
                      class: "w-full px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold transition-all text-base md:text-lg shadow-xl hover:shadow-2xl animate-pulse" %>
      </div>
    </div>
  <% end %>
</div>

<script>
  // Persist rules toggle state across page refreshes
  document.addEventListener('DOMContentLoaded', function() {
    const rulesPanel = document.getElementById('rules-panel');
    const rulesToggleBtn = document.getElementById('rules-toggle-btn');

    if (!rulesPanel || !rulesToggleBtn) return;  // Guard for non-game pages

    // Restore state from localStorage
    const rulesVisible = localStorage.getItem('chromatic_rules_visible') === 'true';
    if (rulesVisible) {
      rulesPanel.classList.remove('hidden');
    }

    // Save state on toggle
    rulesToggleBtn.addEventListener('click', function() {
      // Wait for toggle to complete, then save state
      setTimeout(function() {
        const isVisible = !rulesPanel.classList.contains('hidden');
        localStorage.setItem('chromatic_rules_visible', isVisible);
      }, 50);
    });
  });
</script>
