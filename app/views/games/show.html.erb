<div class="max-w-7xl mx-auto p-8">
  <!-- Turn Indicator -->
  <% if @game.status == 'active' %>
    <div class="mb-6 text-center">
      <% if @game.game_state['turn'] == 'player' %>
        <div class="inline-block px-8 py-4 bg-green-100 border-2 border-green-500 text-green-800 rounded-lg text-2xl font-bold">
          YOUR TURN
        </div>
      <% else %>
        <div class="inline-block px-8 py-4 bg-gray-100 border-2 border-gray-400 text-gray-600 rounded-lg text-2xl font-bold">
          AI THINKING...
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Header -->
  <div class="flex justify-between items-start mb-6">
    <div>
      <%= link_to "‚Üê Back to Games", root_path, class: "text-blue-600 hover:underline text-sm" %>
      <h1 class="text-2xl font-bold mt-2 text-gray-800">Chromatic - Game <%= @game.id %></h1>

      <!-- Deck state display -->
      <% if @game.status == 'active' %>
        <% deck_size = @game.game_state['deck'].length %>
        <div class="mt-2 inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm
          <%= if deck_size <= 10
                'bg-red-100 border-2 border-red-400 text-red-800'
              elsif deck_size <= 30
                'bg-yellow-100 border-2 border-yellow-400 text-yellow-800'
              else
                'bg-blue-100 border-2 border-blue-400 text-blue-800'
              end %>">
          <span class="font-semibold"><%= deck_size %> cards left</span>
          <% if deck_size <= 10 %>
            <span class="font-bold">‚ö†Ô∏è Ending soon!</span>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Enhanced Score Display -->
    <div class="text-right">
      <div class="text-sm text-gray-600 mb-1">Round <%= @game.current_round %> of <%= @game.total_rounds %></div>
      <div class="flex gap-3">
        <div class="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-400 rounded-xl px-4 py-2 shadow-sm">
          <div class="text-xs text-green-700 font-medium">You</div>
          <div class="text-3xl font-bold text-green-800"><%= @game.player_score %></div>
        </div>
        <div class="bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-400 rounded-xl px-4 py-2 shadow-sm">
          <div class="text-xs text-gray-700 font-medium">AI</div>
          <div class="text-3xl font-bold text-gray-800"><%= @game.ai_score %></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Core Game Rule - Simplified -->
  <% if @game.status == 'active' %>
    <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-400 rounded-xl p-4 mb-6 shadow-sm">
      <div class="flex items-start gap-3">
        <div class="text-3xl">üéØ</div>
        <div>
          <h3 class="text-lg font-bold text-blue-900 mb-1">Core Rule</h3>
          <p class="text-blue-800 font-semibold">Card colors MUST match path colors.</p>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Issue #9: Round End Summary -->
  <% if @game.status == 'round_ending' %>
    <% summary = @game.game_state['round_summary'] %>
    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-8 text-center mb-8 border-2 border-blue-300">
      <h2 class="text-4xl font-bold mb-4 text-blue-900">Round <%= summary['round'] %> Complete! üéâ</h2>

      <div class="grid grid-cols-2 gap-8 max-w-3xl mx-auto mb-6">
        <div class="bg-white rounded-lg p-6 border-2 border-green-300">
          <div class="text-2xl font-bold text-green-700 mb-2">Your Score</div>
          <div class="text-5xl font-bold text-green-600 mb-2"><%= summary['player_round_score'] %></div>
          <div class="text-sm text-gray-600 mb-2">
            <%= summary['player_path_count'] %> <%= 'path'.pluralize(summary['player_path_count']) %> √ó <%= summary['player_multiplier'] %>x multiplier
          </div>
          <% if summary['player_bonus'] && summary['player_bonus'] > 0 %>
            <div class="text-xs text-purple-700 font-bold mb-1">
              ‚≠ê Long Path Bonus: +<%= summary['player_bonus'] %> pts
            </div>
          <% end %>
          <% if summary['player_multiplier'] > 1.0 %>
            <div class="text-xs text-green-700 font-bold mb-2">
              üåà COMBO! (<%= summary['player_base_score'] %> base + <%= summary['player_bonus'] || 0 %> bonus) √ó <%= summary['player_multiplier'] %>x = <%= summary['player_round_score'] %>
            </div>
          <% end %>
          <div class="text-sm text-gray-600">this round</div>
          <div class="mt-4 text-lg">
            Total: <span class="font-bold text-green-700"><%= summary['player_total_before'] %> ‚Üí <%= @game.player_score %></span>
          </div>
        </div>

        <div class="bg-white rounded-lg p-6 border-2 border-red-300">
          <div class="text-2xl font-bold text-red-700 mb-2">AI Score</div>
          <div class="text-5xl font-bold text-red-600 mb-2"><%= summary['ai_round_score'] %></div>
          <div class="text-sm text-gray-600 mb-2">
            <%= summary['ai_path_count'] %> <%= 'path'.pluralize(summary['ai_path_count']) %> √ó <%= summary['ai_multiplier'] %>x multiplier
          </div>
          <% if summary['ai_bonus'] && summary['ai_bonus'] > 0 %>
            <div class="text-xs text-purple-700 font-bold mb-1">
              ‚≠ê Long Path Bonus: +<%= summary['ai_bonus'] %> pts
            </div>
          <% end %>
          <% if summary['ai_multiplier'] > 1.0 %>
            <div class="text-xs text-red-700 font-bold mb-2">
              üåà COMBO! (<%= summary['ai_base_score'] %> base + <%= summary['ai_bonus'] || 0 %> bonus) √ó <%= summary['ai_multiplier'] %>x = <%= summary['ai_round_score'] %>
            </div>
          <% end %>
          <div class="text-sm text-gray-600">this round</div>
          <div class="mt-4 text-lg">
            Total: <span class="font-bold text-red-700"><%= summary['ai_total_before'] %> ‚Üí <%= @game.ai_score %></span>
          </div>
        </div>
      </div>

      <% if summary['player_round_score'] > summary['ai_round_score'] %>
        <p class="text-2xl text-green-600 font-bold mb-4">You won this round!</p>
      <% elsif summary['ai_round_score'] > summary['player_round_score'] %>
        <p class="text-2xl text-red-600 font-bold mb-4">AI won this round!</p>
      <% else %>
        <p class="text-2xl text-gray-600 font-bold mb-4">This round was a tie!</p>
      <% end %>

      <%= button_to "Continue to Round #{@game.current_round + 1}",
                    continue_round_game_path(@game),
                    method: :post,
                    data: { turbo: false },
                    class: "mt-4 px-10 py-4 bg-blue-600 text-white text-2xl rounded-lg hover:bg-blue-700 font-bold shadow-lg" %>
    </div>
  <% end %>

  <% if @game.status == 'finished' %>
    <!-- Game Over -->
    <div class="bg-gray-100 rounded-lg p-8 text-center mb-8">
      <h2 class="text-4xl font-bold mb-4">Game Over!</h2>
      <% if @game.winner == 'player' %>
        <p class="text-2xl text-green-600">You Win!</p>
      <% elsif @game.winner == 'ai' %>
        <p class="text-2xl text-red-600">AI Wins!</p>
      <% else %>
        <p class="text-2xl text-gray-600">It's a Tie!</p>
      <% end %>
      <div class="mt-4 text-xl">
        Final Score - You: <%= @game.player_score %> | AI: <%= @game.ai_score %>
      </div>
      <%= link_to "Play Again", root_path, class: "mt-6 inline-block px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700" %>
    </div>
  <% end %>

  <% if notice %>
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
      <%= notice %>
    </div>
  <% end %>

  <% if alert %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <%= alert %>
    </div>
  <% end %>

  <!-- Main Layout: Sidebar + Game Area -->
  <div class="flex flex-col lg:flex-row gap-4 mb-6">
    <!-- Color Rules Sidebar - Always Visible on Desktop, Collapsible on Mobile -->
    <div id="rules-sidebar" class="lg:w-72 flex-shrink-0">
      <div class="bg-gradient-to-br from-white to-gray-50 rounded-lg border-2 border-gray-300 shadow-md sticky top-4">
        <div class="px-3 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white flex justify-between items-center rounded-t-md cursor-pointer lg:cursor-default"
             onclick="if(window.innerWidth < 1024) { document.getElementById('rules-content').classList.toggle('hidden'); document.getElementById('toggle-arrow').classList.toggle('rotate-180'); }">
          <h3 class="font-bold text-sm flex items-center gap-1">
            <span>üìö</span>
            <span>Quick Reference</span>
            <span id="toggle-arrow" class="lg:hidden transition-transform">‚ñº</span>
          </h3>
          <button
            onclick="event.stopPropagation(); document.getElementById('rules-sidebar').classList.add('hidden'); document.getElementById('show-rules-btn').classList.remove('hidden')"
            class="hidden lg:block text-white hover:text-gray-200 text-xs px-2 py-0.5 rounded hover:bg-white/20 transition"
            title="Hide rules">
            ‚úï
          </button>
        </div>

        <div id="rules-content" class="p-3 space-y-2.5 max-h-[75vh] overflow-y-auto">
          <!-- Compact Color Rules -->
          <div class="space-y-1.5">
            <div class="bg-red-50 px-2 py-1.5 rounded border-l-4 border-red-500 hover:bg-red-100 transition">
              <div class="font-bold text-red-700 text-xs flex items-center gap-1">
                <span>üî¥</span>
                <span>Red: Jump +2</span>
              </div>
              <div class="text-xs text-gray-600 ml-4">2‚Üí5‚Üí9 (max 10)</div>
            </div>
            <div class="bg-blue-50 px-2 py-1.5 rounded border-l-4 border-blue-500 hover:bg-blue-100 transition">
              <div class="font-bold text-blue-700 text-xs flex items-center gap-1">
                <span>üîµ</span>
                <span>Blue: Pairs ¬±3</span>
              </div>
              <div class="text-xs text-gray-600 ml-4">7‚Üí9‚Üí11‚Üí8 (max 10)</div>
            </div>
            <div class="bg-green-50 px-2 py-1.5 rounded border-l-4 border-green-500 hover:bg-green-100 transition">
              <div class="font-bold text-green-700 text-xs flex items-center gap-1">
                <span>üü¢</span>
                <span>Green: Consecutive</span>
              </div>
              <div class="text-xs text-gray-600 ml-4">8‚Üí9‚Üí10 (max 5)</div>
            </div>
            <div class="bg-yellow-50 px-2 py-1.5 rounded border-l-4 border-yellow-500 hover:bg-yellow-100 transition">
              <div class="font-bold text-yellow-700 text-xs flex items-center gap-1">
                <span>üü°</span>
                <span>Yellow: +1 to 3</span>
              </div>
              <div class="text-xs text-gray-600 ml-4">2‚Üí3‚Üí6‚Üí8 (max 10)</div>
            </div>
            <div class="bg-purple-50 px-2 py-1.5 rounded border-l-4 border-purple-500 hover:bg-purple-100 transition">
              <div class="font-bold text-purple-700 text-xs flex items-center gap-1">
                <span>üü£</span>
                <span>Purple: Descend</span>
              </div>
              <div class="text-xs text-gray-600 ml-4">20‚Üí17‚Üí10 (max 10)</div>
            </div>
          </div>

          <!-- Divider -->
          <div class="border-t-2 border-gray-200"></div>

          <!-- Scoring Systems - Ultra Compact -->
          <div class="space-y-1.5">
            <div class="bg-purple-50 px-2 py-1.5 rounded border-l-2 border-purple-400">
              <div class="font-bold text-purple-900 text-xs mb-0.5 flex items-center gap-1">
                <span>üìà</span>
                <span>Base Score: (cards)¬≤</span>
              </div>
              <div class="text-xs text-gray-700 ml-4 leading-tight">
                3 cards = 9pts, 5 = 25pts
              </div>
            </div>

            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 px-2 py-1.5 rounded border-l-2 border-yellow-500">
              <div class="font-bold text-yellow-900 text-xs mb-0.5 flex items-center gap-1">
                <span>üåà</span>
                <span>Combo Multiplier</span>
              </div>
              <div class="text-xs text-gray-700 ml-4 leading-tight">
                2‚Üí1.1x | 3‚Üí1.25x | 5‚Üí1.6x
              </div>
            </div>

            <div class="bg-pink-50 px-2 py-1.5 rounded border-l-2 border-pink-400">
              <div class="font-bold text-pink-900 text-xs mb-0.5 flex items-center gap-1">
                <span>‚≠ê</span>
                <span>Long Path Bonus</span>
              </div>
              <div class="text-xs text-gray-700 ml-4 leading-tight">
                5‚Üí+5 | 7‚Üí+10 | 10‚Üí+20
              </div>
            </div>

            <div class="bg-blue-50 px-2 py-1.5 rounded border-l-2 border-blue-400">
              <div class="font-bold text-blue-900 text-xs mb-0.5 flex items-center gap-1">
                <span>üí∞</span>
                <span>Path Costs</span>
              </div>
              <div class="text-xs text-gray-700 ml-4 leading-tight">
                1st FREE | 2nd: 1 | 3rd-5th: 2-4
              </div>
            </div>
          </div>

          <!-- Pro Tip -->
          <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-2 py-1.5 rounded border border-green-300">
            <div class="text-xs font-semibold text-green-800 mb-0.5">üí° Strategy Tip</div>
            <div class="text-xs text-gray-700 leading-tight">
              Balance path length vs. combo multipliers for max points!
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Show Rules Button (when hidden) -->
    <button
      id="show-rules-btn"
      onclick="document.getElementById('rules-sidebar').classList.remove('hidden'); this.classList.add('hidden')"
      class="hidden fixed top-20 left-4 z-10 px-3 py-2 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 text-sm font-bold">
      üìö Show Rules
    </button>

    <!-- Game Content Area -->
    <div class="flex-1 min-w-0">

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Player Side -->
        <div>
          <h2 class="text-2xl font-bold mb-4">Your Paths</h2>
      <div class="space-y-3">
        <% if @game.player_paths.any? %>
          <% @game.player_paths.each do |path| %>
            <%= render partial: 'color_path', locals: { path: path } %>
          <% end %>
        <% else %>
          <div class="text-gray-500 text-center py-8 border-2 border-dashed rounded-lg">
            No paths yet. <strong class="text-green-600">First path is FREE!</strong>
          </div>
        <% end %>
          </div>
        </div>

        <!-- AI Side -->
        <div>
          <h2 class="text-2xl font-bold mb-4">AI Paths</h2>
      <div class="space-y-3">
        <% if @game.ai_paths.any? %>
          <% @game.ai_paths.each do |path| %>
            <%= render partial: 'color_path', locals: { path: path } %>
          <% end %>
        <% else %>
          <div class="text-gray-500 text-center py-8 border-2 border-dashed rounded-lg">
            AI hasn't played yet
          </div>
        <% end %>
          </div>
        </div>
      </div>

      <!-- Your Hand -->
  <% if @game.status == 'active' %>
    <div class="mt-6 bg-gradient-to-b from-blue-50 to-white border-2 border-blue-300 rounded-lg p-4 shadow-md">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-bold text-gray-800">üÉè Your Hand (<%= @game.player_hand.length %>)</h2>
        <div class="text-xs text-gray-600 italic">üéØ Match card colors to path colors</div>
      </div>

      <div class="flex flex-wrap gap-3 mb-3">
        <% @game.player_hand.each_with_index do |card, index| %>
          <%= render partial: 'card', locals: { card: card, index: index, game: @game } %>
        <% end %>
      </div>

      <!-- End Turn Section - With Clear Status -->
      <div class="mt-4 space-y-2">
        <% hand_size = @game.player_hand.length %>
        <% has_cards = hand_size > 0 %>

        <% if has_cards %>
          <!-- Warning: Still have cards -->
          <div class="bg-amber-50 border border-amber-400 rounded-lg p-3 text-center">
            <div class="flex items-center justify-center gap-2 mb-1">
              <span class="text-xl">‚ö†Ô∏è</span>
              <div class="text-sm font-bold text-amber-900">Still have <%= hand_size %> <%= 'card'.pluralize(hand_size) %>!</div>
            </div>
            <div class="text-xs text-amber-700">
              Play or discard all cards before ending turn
            </div>
          </div>

          <!-- Disabled End Turn Button -->
          <button
            disabled
            class="w-full px-8 py-3 bg-gray-300 text-gray-500 rounded-lg font-bold text-lg cursor-not-allowed opacity-60"
            title="You must play or discard all cards before ending your turn">
            End Turn ‚Üí (Play/Discard all cards first)
          </button>
        <% else %>
          <!-- Ready to End Turn -->
          <div class="bg-green-50 border border-green-400 rounded-lg p-2 text-center">
            <div class="flex items-center justify-center gap-2 text-green-800">
              <span class="text-lg">‚úì</span>
              <span class="font-bold text-sm">Ready to end turn!</span>
            </div>
          </div>

          <%= button_to "End Turn ‚Üí",
                        end_turn_game_path(@game),
                        method: :post,
                        data: { turbo: false, confirm: "End your turn? The AI will play next." },
                        class: "w-full px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold transition-all text-lg shadow-lg hover:shadow-xl" %>
        <% end %>
      </div>
    </div>
  <% end %>
    </div>
  </div>
</div>
