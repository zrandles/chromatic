# Chromatic Fix Plan - October 15, 2025

## Issues Identified

### 1. Rules Toggle State Doesn't Persist
**Problem**: When a card is played, page refreshes and rules panel resets to hidden state
**Impact**: Annoying UX - user has to re-toggle rules after every action
**User Quote**: "rules toggle should keep same state when a card is played"

### 2. AI Doesn't Auto-Play Turn
**Problem**: AI doesn't automatically take its turn after player action
**Impact**: Player has to manually trigger AI turn (confusing workflow)
**User Quote**: "ai and player should take turns"

### 3. Must Click End Turn Multiple Times
**Problem**: Each AI play requires a separate "End Turn" click
**Impact**: Tedious interaction pattern
**User Quote**: "it looks like i have to click 'end turn' once for every play of the ai"

### 4. Game Stuck When Deck Empty
**Problem**: Can't discard when deck is empty, but discard is required to end turn
**Impact**: Game becomes unplayable in late rounds
**User Quote**: "i can't discard when the deck is empty (means the game is stuck)"

### 5. Manual Discard Still Required
**Problem**: Player must manually discard all cards before ending turn
**Impact**: Extra clicks, friction in game flow
**User Quote**: "clicking end turn button with cards left should auto-discard them"

### 6. Individual Discard Buttons Are Clutter
**Problem**: Discard button below every card is visual noise
**Impact**: Cluttered UI, confusing when it's actually needed
**User Quote**: "get rid of discard button below every card"

### 7. Empty Paths Not Displayed
**Problem**: Only shows paths that have been started (1+ cards)
**Impact**: Hard to see which colors are available, strategic planning limited
**User Quote**: "show all paths by default, even if they're empty"

### 8. No Hints for Unstarted Paths
**Problem**: Path hints only show for paths with cards
**Impact**: Hard to know what cards are valid starters for each color
**User Quote**: "show path hints always, even if no cards have been played"

---

## Solution Plan

### Issue 1: Rules Toggle State Persistence
**Approach**: Use JavaScript localStorage to persist toggle state

**Implementation**:
```erb
<!-- show.html.erb -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const rulesPanel = document.getElementById('rules-panel');
    const rulesToggleBtn = document.getElementById('rules-toggle-btn');

    // Restore state from localStorage
    const rulesVisible = localStorage.getItem('chromatic_rules_visible') === 'true';
    if (rulesVisible) {
      rulesPanel.classList.remove('hidden');
    }

    // Save state on toggle
    rulesToggleBtn.addEventListener('click', function() {
      const isVisible = !rulesPanel.classList.contains('hidden');
      localStorage.setItem('chromatic_rules_visible', isVisible);
    });
  });
</script>
```

**Files to Modify**:
- `app/views/games/show.html.erb` (add script, add id to button)

**Complexity**: Low
**Risk**: None

---

### Issue 2-3: AI Auto-Play After Player Action
**Approach**: AI plays immediately after player action in controller, loop until AI stuck or turn ends naturally

**Current Flow**:
1. Player plays card → redirect
2. Player clicks "End Turn" → AI plays once → redirect
3. Player clicks "End Turn" → AI plays once → redirect
4. (repeat until AI can't play)

**New Flow**:
1. Player plays card → AI plays all valid moves → redirect
2. Player clicks "End Turn" → round ends (if applicable)

**Implementation**:
```ruby
# app/controllers/games_controller.rb

def play_card
  @game = Game.find(params[:id])
  result = @game.play_card(params[:card_index].to_i, params[:color], 'player')

  if result[:success]
    # AI plays until it can't play anymore or round ends
    ai_play_full_turn

    drew_cards = result[:drew_cards] || 1
    redirect_to game_path(@game), notice: "Card played! Drew #{drew_cards} card#{'s' if drew_cards > 1}."
  else
    redirect_to game_path(@game), alert: result[:error]
  end
end

def end_turn
  @game = Game.find(params[:id])

  # Auto-discard all remaining cards (Issue 5 fix)
  while @game.player_hand.any? && !@game.game_state['deck'].empty?
    @game.discard_and_draw(0)
  end

  # If deck empty, allow ending turn without discarding (Issue 4 fix)
  @game.player_hand.clear if @game.game_state['deck'].empty?
  @game.save

  # AI plays full turn
  ai_play_full_turn

  redirect_to game_path(@game)
end

private

def ai_play_full_turn
  # AI plays until it can't play anymore
  max_plays = 20  # Safety limit
  plays = 0

  while plays < max_plays
    initial_hand_size = @game.ai_hand.length
    @game.ai_play

    # If AI hand didn't change, it couldn't play
    break if @game.ai_hand.length == initial_hand_size

    plays += 1
  end

  # After AI is done, check if round should end
  @game.end_turn
end
```

**Files to Modify**:
- `app/controllers/games_controller.rb` (play_card, end_turn, new ai_play_full_turn method)

**Complexity**: Medium
**Risk**: Medium (AI could get stuck in loop if logic is wrong)

**Testing Required**:
- AI plays multiple cards in sequence
- AI stops when no valid plays
- Round ends correctly after AI turn
- No infinite loops

---

### Issue 4: Game Stuck When Deck Empty
**Solution**: Allow ending turn without discard if deck is empty

**Implementation**: (Already included in end_turn method above)
```ruby
# If deck empty, just clear hand without drawing
@game.player_hand.clear if @game.game_state['deck'].empty?
```

**Files to Modify**:
- `app/controllers/games_controller.rb` (end_turn method)

**Complexity**: Low
**Risk**: Low

---

### Issue 5: Auto-Discard on End Turn
**Solution**: Automatically discard all cards when End Turn clicked

**Implementation**: (Already included in end_turn method above)
```ruby
# Auto-discard all remaining cards
while @game.player_hand.any? && !@game.game_state['deck'].empty?
  @game.discard_and_draw(0)
end
```

**Files to Modify**:
- `app/controllers/games_controller.rb` (end_turn method)

**Complexity**: Low
**Risk**: Low

---

### Issue 6: Remove Individual Discard Buttons
**Solution**: Remove discard button from _card.html.erb, remove discard_card action

**Implementation**:
1. Remove discard button from card partial
2. Remove discard_card route
3. Remove discard_card controller action

**Files to Modify**:
- `app/views/games/_card.html.erb` (remove lines 30-40)
- `config/routes.rb` (remove discard_card route)
- `app/controllers/games_controller.rb` (remove discard_card action)

**Complexity**: Low
**Risk**: None

---

### Issue 7: Show All Paths (Even Empty)
**Solution**: Always render all 5 colors, show "Not started" state for empty paths

**Implementation**:
```erb
<!-- app/views/games/show.html.erb -->
<% ['red', 'blue', 'green', 'yellow', 'purple'].each do |color| %>
  <%
    player_path = @game.player_paths.find_by(color: color)
    ai_path = @game.ai_paths.find_by(color: color)
    # REMOVED: next if player_path.nil? && ai_path.nil?

    player_score = player_path&.score || 0
    ai_score = ai_path&.score || 0
  %>

  <div class="border-2 rounded-lg p-3 md:p-4 <%= bg_class %>">
    <!-- Color Header -->
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-2">
        <span class="text-xl"><%= color_emoji %></span>
        <span class="font-bold capitalize text-gray-800"><%= color %></span>
        <span class="text-xs text-gray-600">(<%= color_rule %>)</span>
      </div>
    </div>

    <!-- Side-by-Side Comparison -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <!-- Your Path -->
      <div class="bg-white rounded-lg p-3 border-2 <%= player_path ? 'border-green-300' : 'border-gray-200' %>">
        <div class="text-xs font-semibold text-gray-600 mb-1">YOU</div>
        <% if player_path %>
          <!-- Existing path display -->
        <% else %>
          <div class="text-gray-400 text-sm italic">Not started</div>
          <div class="mt-2 pt-2 border-t border-gray-200 text-xs text-gray-700">
            Starter cost: <span class="font-semibold"><%= @game.starting_cost_for_path_number(@game.player_paths.count) %> cards</span>
          </div>
        <% end %>
      </div>

      <!-- AI Path (similar) -->
    </div>
  </div>
<% end %>
```

**Files to Modify**:
- `app/views/games/show.html.erb` (remove conditional skip, add empty state)

**Complexity**: Low
**Risk**: None

---

### Issue 8: Show Hints for All Paths
**Solution**: Show starting requirements for unstarted paths

**Implementation**: (Already included in Issue 7 solution above)
```erb
<% if player_path %>
  <!-- Existing path display with next play hint -->
<% else %>
  <div class="text-gray-400 text-sm italic">Not started</div>
  <div class="mt-2 pt-2 border-t border-gray-200 text-xs text-gray-700">
    Starter cost: <span class="font-semibold"><%= @game.starting_cost_for_path_number(@game.player_paths.count) %> cards</span>
  </div>
  <div class="text-xs text-gray-600 mt-1">
    Rule: <%= full_color_rule(color) %>
  </div>
<% end %>
```

**Files to Modify**:
- `app/views/games/show.html.erb` (add starter hints to empty paths)

**Complexity**: Low
**Risk**: None

---

## Implementation Order

### Phase 1: Quick Wins (Low Risk)
1. ✅ Issue 6: Remove discard buttons
2. ✅ Issue 7: Show all paths
3. ✅ Issue 8: Show hints for empty paths
4. ✅ Issue 1: Rules toggle persistence

### Phase 2: Controller Logic (Medium Risk)
5. ✅ Issue 4: Handle empty deck
6. ✅ Issue 5: Auto-discard on end turn
7. ✅ Issue 2-3: AI auto-play (requires careful testing)

### Phase 3: Testing
8. ✅ Test all changes locally
9. ✅ Deploy to production
10. ✅ Verify all fixes working

---

## Rails Expert Consultation Questions

1. **AI Auto-Play Loop**: Is `ai_play_full_turn` approach safe? Any risk of infinite loops?
2. **Hand Clearing**: Is `@game.player_hand.clear` safe, or should we use a model method?
3. **Multiple Saves**: Should we batch saves in `ai_play_full_turn`, or is current approach okay?
4. **Turbo Frames**: Should we consider Turbo Frames instead of full page refreshes?
5. **Code Organization**: Should controller logic move to model methods?
6. **State Persistence**: Is localStorage appropriate for rules toggle, or better Rails solution?
7. **Security**: Any concerns with auto-discarding player cards server-side?

---

## Success Criteria

- ✅ Rules toggle stays open/closed across page refreshes
- ✅ AI plays full turn immediately after player action
- ✅ Player only clicks "End Turn" once per turn
- ✅ Game doesn't get stuck when deck is empty
- ✅ No manual discard buttons (auto-discard on end turn)
- ✅ All 5 color paths always visible
- ✅ Hints show for all paths (started or not)
- ✅ No regressions in existing functionality

---

## Risk Assessment

**Low Risk Changes**:
- Remove discard buttons
- Show all paths
- Show hints for empty paths
- Rules toggle persistence

**Medium Risk Changes**:
- AI auto-play loop (could cause infinite loop if buggy)
- Auto-discard logic (could discard wrong cards)
- Hand clearing when deck empty (edge case handling)

**Mitigation**:
- Extensive local testing before deploy
- Safety limit on AI plays (max 20)
- Follow mandatory bug fix workflow from CONTEXT.md
- Rails Expert review of controller logic
